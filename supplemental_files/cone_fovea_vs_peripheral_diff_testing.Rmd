---
title: "Test Fovea vs Peripheral Cones"
output: html_notebook
---

# Load
```{r}
library(Seurat)
library(tidyverse)
library(SingleCellExperiment)
library(scran)
library(org.Hs.eg.db)
#system('wget -O ~/Downloads/scEiaD_all_seurat_v3.Rdata https://hpc.nih.gov/~mcgaugheyd/scEiaD/2022_03_22/scEiaD_all_seurat_v3.Rdata)
# the -O renames the file and puts it in the ~/data/scEiaD directory
load('~/Downloads/scEiaD_all_seurat_v3.Rdata')
```
## Compare macula cones vs peripheral cones
Let us now demonstrate how having a large annotated set of data can be of value in asking more specific questions, like "how do macula/fovea cones differ relative to peripheral cones."

First, we need to see whether this is even a tractable question.
```{r}
scEiaD@meta.data %>% 
  as_tibble() %>% 
  group_by(retina_region, organism, study_accession, CellType_predict) %>% 
  summarise(Count = n()) %>% 
  filter(CellType_predict %in% c("Cone")) %>% 
  filter(Count > 10, !is.na(retina_region))
```

Yes, we have several human studies with macula / peripheral cone cells. 

Let's demonstrate how we can quickly run a conservative differential expression test the leverages the many studies we have. The "traditional" scRNA diff tests often return insane numbers of differentially expressed genes, which is  annoying as then you have to plot each result individually to confirm that it does not look wacky. We are going to build a "pseudo bulk" experiment here where we sum all the counts by gene, cell type (in this case we are doing macula cones *versus* peripheral cones), and study. This "pseudo" count table can then be used in a classic differential testing system like edgeR, limma, or DESeq2 (we will use the later).

```{r}
# Create new column with a pasted together retina region and a CellType
scEiaD <- AddMetaData(scEiaD, 
                      metadata = 
                        paste0(
                          scEiaD@meta.data$retina_region, 
                          '_', 
                          scEiaD@meta.data$CellType_predict,
                          '_',
                          scEiaD@meta.data$organism
                        ), 
                      col.name = 'regionCT')


# filter down scEiaD to only human and in semi-supported (more than 10 cones cells) studies
Idents(scEiaD) <- scEiaD@meta.data$regionCT
scEiaD__subset <- subset(scEiaD, idents = c('Macula_Cone_Homo sapiens','Peripheral_Cone_Homo sapiens'))
scEiaD__subset <- subset(scEiaD__subset, 
                         subset = study_accession %in% 
                           (scEiaD__subset@meta.data %>% group_by(study_accession) %>% 
                              summarise(Count = n()) %>% filter(Count > 10) %>% 
                              pull(study_accession)))
# create SCE object so can create a pseudobulk matrix to run DESeq2 on
sce <- as.SingleCellExperiment(scEiaD__subset)
summed <- scater::aggregateAcrossCells(sce, 
                                       ids=colData(sce)[,c("regionCT", "study_accession")])
# pull out the counts to build the DESeq2 object
mat <- assay(summed, 'counts')
colnames(mat) <-colData(summed) %>% as_tibble() %>% 
  mutate(names = glue::glue("{study_accession}_{retina_region}")) %>% pull(names)

library(DESeq2)
dds <- DESeqDataSetFromMatrix(countData = round(mat),
                              colData = colData(summed),
                              design= ~ study_accession + retina_region) # study as covariate, testing against fovea / not fovea
dds <- DESeq(dds)
deseq_res <- results(dds)
```

### Wrinkle

scEiaD is based on the Ensembl gene id (like ENSG00000185527). That's not very friendly to humans so I added a bit of code to link the Ensembl ID to the gene name and plot the top differentially expressed genes (padj < 0.05). 

```{r}
# get human gene names 
library(org.Hs.eg.db)
symbols <- mapIds(org.Hs.eg.db, keys = row.names(deseq_res), keytype = "ENSEMBL", column="SYMBOL")

deseq_res %>% as_tibble(rownames = 'name') %>%  
  left_join(symbols %>% enframe()) %>% 
  dplyr::rename(Ensembl = name, Gene = value) %>% 
  filter(padj < 0.05) %>% 
  arrange(pvalue) %>% DT::datatable()
```

### Always look at the plots

#### PDE6G 
Top gene more highly expressed in the macula compared to the periphery. Seems pretty consistently higher across all the studies. 
```{r}
scEiaD__subset <- ScaleData(scEiaD__subset)
VlnPlot(scEiaD__subset, features = c('ENSG00000185527'), log = TRUE)

VlnPlot(scEiaD__subset, c('ENSG00000185527'), split.by = 'retina_region', group.by='study_accession', log = TRUE) 
```

#### HSPB1
Now we see the opposite side - the top gene that is higher in peripheral vs macula. Again looks fairly consistent across all the studies.
```{r}
VlnPlot(scEiaD__subset, features = c('ENSG00000099860'))

VlnPlot(scEiaD__subset, c('ENSG00000099860'), split.by = 'regionCT', group.by='study_accession', ) + aes(color=scEiaD__subset$regionCT)
```


#### PRPH2
Yan et al (https://www.nature.com/articles/s41598-020-66092-9) proposed PRPH2 as a cone fovea/peripheral specific gene. We can see whether that effect is still shown across multiple studies in scEiaD. We see the padj is not impressive in our diff test. 

```{r}
# first grab the ensembl id
deseq_res %>% as_tibble(rownames = 'name') %>%  
  left_join(symbols %>% enframe()) %>% 
  dplyr::rename(Ensembl = name, Gene = value) %>% 
  filter(Gene == 'PRPH2')
```

The plots certainly do not DISPROVE the Yan et al hypothesis - you still see that the trend is (mostly) the same across all the studies. However the p value is likely low for because the effect size (fold change) is modest across most studies (and in one case, the effect is opposite). As a exercise to the reader, you could re-do the pseudobulk test, removing SRP194595 and seeing whether padj value you get returned is substantially different. 

```{r}
VlnPlot(scEiaD__subset, features = c('ENSG00000112619'))

VlnPlot(scEiaD__subset, c('ENSG00000112619'), split.by = 'regionCT', group.by='study_accession', ) + aes(color=scEiaD__subset$regionCT)

```


# Save our file
```{r}
save(scEiaD__subset, file = 'scEiaD_fovea_vs_peripheral_cone.seuratV3.Rdata')
```

```{r}
devtools::session_info()
```
